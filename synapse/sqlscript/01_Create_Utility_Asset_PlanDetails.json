{
	"name": "01_Create_Utility_Asset_PlanDetails",
	"properties": {
		"content": {
			"query": "/*****************************************************************************************/\n/** PlanDetails                                                                         **/\n/**     What:   Stores full XML execution plans from Query Store.                       **/\n/**                                                                                     **/\n/**     Why:    Offers deep insight into operator choices for postâ€‘mortem analysis.     **/\n/*****************************************************************************************/\n\n-------------------------------------------------------------------------------------------\n--  Table Design: Telemetry.PlanDetails \n-------------------------------------------------------------------------------------------\nCREATE TABLE Telemetry.PlanDetails\n(\n  CaptureTime DATETIME2     NOT NULL,\n  QueryId     BIGINT        NOT NULL,\n  PlanId      BIGINT        NOT NULL,\n  PlanXml     NVARCHAR(4000) NOT NULL\n)\nWITH\n(\n  DISTRIBUTION = ROUND_ROBIN\n);\n\n-------------------------------------------------------------------------------------------\n--  Table Design: Telemetry.usp_PlanDetails \n-------------------------------------------------------------------------------------------\nCREATE PROCEDURE Telemetry.usp_CapturePlanDetails\n  @CaptureTime DATETIME2\nAS\nBEGIN\n  DECLARE @minElapsed BIGINT = (SELECT IntValue FROM Telemetry.CaptureSettings\n                                WHERE SettingName='MinPlanCaptureElapsedMs');\n  INSERT INTO Telemetry.PlanDetails (CaptureTime, QueryId, PlanId, PlanXml)\n  SELECT\n    @CaptureTime,\n    q.query_id,\n    p.plan_id,\n    p.query_plan\n  FROM sys.query_store_runtime_stats rs\n  JOIN sys.query_store_plan p\n    ON rs.plan_id = p.plan_id\n  JOIN sys.query_store_query q\n    ON p.query_id = q.query_id\n  WHERE rs.max_duration_ms > @minElapsed;\nEND;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "dspendtoenddemo",
				"poolName": "dspendtoenddemo"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}